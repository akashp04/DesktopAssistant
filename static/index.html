<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desktop Assistant - Document Search</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #f5f5f5; 
        }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .search-section { margin-bottom: 30px; }
        .search-box { 
            width: 100%; 
            padding: 15px; 
            font-size: 16px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            margin: 10px 0; 
            box-sizing: border-box;
        }
        .search-controls { display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; align-items: center; }
        .search-button { 
            padding: 15px 30px; 
            font-size: 16px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: background 0.3s;
        }
        .search-button:hover { background: #0056b3; }
        .search-button:disabled { background: #ccc; cursor: not-allowed; }
        .search-type { display: flex; gap: 15px; align-items: center; }
        .search-type label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .results { margin-top: 30px; }
        .result-item { 
            border: 1px solid #e0e0e0; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px; 
            background: #fafafa; 
            transition: box-shadow 0.3s;
        }
        .result-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .result-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            gap: 20px; /* Add space between file name and scores */
        }
        .file-name { 
            font-weight: bold; 
            color: #1565C0; 
            font-size: 18px; 
            flex: 1; /* Allow filename to take available space */
        }
        .scores { 
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap; 
            flex-shrink: 0; /* Prevent scores from shrinking */
        }
        .score-badge { 
            color: white; 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 11px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .semantic-score { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        }
        .keyword-score { 
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
        }
        .exact-score { 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
        }
        .final-score { 
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); 
            font-weight: bold; 
            font-size: 12px;
            padding: 7px 14px;
        }
        .result-content { margin-top: 15px; line-height: 1.6; color: #555; }
        .loading { text-align: center; color: #666; margin: 20px 0; }
        .error { background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .info { background: #e3f2fd; color: #1565c0; padding: 15px; border-radius: 8px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Desktop Assistant - Document Search</h1>
        
        <div class="search-section">
            <input type="text" class="search-box" placeholder="Search your documents..." id="searchBox" 
                   onkeypress="if(event.key==='Enter') search()">
            
            <div class="search-controls">
                <button onclick="search()" class="search-button" id="searchBtn">üîç Search</button>
                
                <div class="search-type">
                    <label><input type="radio" name="searchType" value="semantic" checked> Semantic</label>
                    <label><input type="radio" name="searchType" value="hybrid"> Hybrid</label>
                </div>
                
                <input type="number" id="topK" placeholder="Results" value="5" min="1" max="20" 
                       style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>

        <div id="status" class="info" style="display: none;"></div>
        <div id="results" class="results"></div>
    </div>

    <script>
        async function search() {
            const query = document.getElementById('searchBox').value.trim();
            if (!query) {
                showError('Please enter a search query');
                return;
            }

            const searchBtn = document.getElementById('searchBtn');
            const resultsDiv = document.getElementById('results');
            const statusDiv = document.getElementById('status');
            
            // Show loading state
            searchBtn.disabled = true;
            searchBtn.textContent = 'üîÑ Searching...';
            statusDiv.style.display = 'block';
            statusDiv.className = 'info';
            statusDiv.textContent = 'Searching documents...';
            resultsDiv.innerHTML = '';

            try {
                const searchType = document.querySelector('input[name="searchType"]:checked').value;
                const topK = parseInt(document.getElementById('topK').value) || 5;
                
                let endpoint, payload;
                
                if (searchType === 'hybrid') {
                    endpoint = '/search/hybrid';
                    payload = {
                        query: query,
                        top_k: topK,
                        semantic_weight: 1.0,
                        keyword_weight: 1.0,
                        exact_weight: 2.0
                    };
                } else {
                    endpoint = '/search/';
                    payload = {
                        query: query,
                        top_k: topK,
                        score_threshold: 0.0
                    };
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || `HTTP ${response.status}`);
                }
                
                displayResults(data, searchType);
                
            } catch (error) {
                showError(`Search failed: ${error.message}`);
                console.error('Search error:', error);
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'üîç Search';
                statusDiv.style.display = 'none';
            }
        }

        function displayResults(data, searchType) {
            const resultsDiv = document.getElementById('results');
            
            if (!data.results || data.results.length === 0) {
                resultsDiv.innerHTML = '<div class="info">No results found. Try different keywords.</div>';
                return;
            }

            let html = `<div class="info">
                Found ${data.total_results} results in ${data.processing_time_ms}ms`;
            
            if (searchType === 'hybrid' && data.search_breakdown) {
                html += ` (Semantic: ${data.search_breakdown.semantic_matches}, 
                         Keyword: ${data.search_breakdown.keyword_matches}, 
                         Exact: ${data.search_breakdown.exact_matches})`;
            }
            html += '</div>';

            html += data.results.map(result => `
                <div class="result-item">
                    <div class="result-header">
                        <div class="file-name">${escapeHtml(result.file_name)}</div>
                        <div class="scores">
                            ${searchType === 'hybrid' ? `
                                <span class="score-badge semantic-score">S: ${result.semantic_score.toFixed(3)}</span>
                                <span class="score-badge keyword-score">K: ${result.keyword_score.toFixed(3)}</span>
                                <span class="score-badge exact-score">E: ${result.exact_match_score.toFixed(3)}</span>
                                <span class="score-badge final-score">Final: ${result.final_score.toFixed(3)}</span>
                            ` : `
                                <span class="score-badge final-score">Score: ${result.score.toFixed(3)}</span>
                            `}
                        </div>
                    </div>
                    <div style="color: #666; font-size: 14px; margin: 5px 0;">
                        ${escapeHtml(result.file_path)} (Chunk ${result.chunk_index}/${result.total_chunks})
                    </div>
                    <div class="result-content">${escapeHtml(result.chunk_text)}</div>
                </div>
            `).join('');

            resultsDiv.innerHTML = html;
        }

        function showError(message) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<div class="error">‚ùå ${escapeHtml(message)}</div>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Test connection on page load
        window.onload = async function() {
            try {
                const response = await fetch('/api');
                const data = await response.json();
                console.log('‚úÖ Connected to:', data.message);
            } catch (error) {
                showError('Failed to connect to API. Make sure the server is running.');
                console.error('Connection error:', error);
            }
        };
    </script>
</body>
</html>